# 모노레포에 있는 디자인 시스템 배포 해서 다른 서비스에 적용하기

## 걱정하면서 단계적으로 어떻게 할건지 고민 고민

1. 준비

   1. 어떻게 하면 빠른 디버깅을 할 수 있을 것인가?
      1. pack으로 묶어서 바로 바로 설치하면서 확인 -> 별다른 고민 없이 복붙만 하면 됨
      2. localhost로 가상 라이브러리 서버를 설치해서 사용 -> pack이 성공 했을 시 실제 환경과 조금 더 비슷하게 맞추기 위해서 사용
      3. git actions로 노가다 하면서 배포 시스템 구축하기
   2. 일단 예상하기 어려운건 지우고 시작 하자
      1. 일단 기존 css는 다지우자 지금 하는 것만으로도 벅차다
      2. 방해 되는건 일단 다 지워버린다.

2. 빌드

   1. svg를 svgr로 사용하고 있는대 어떻게 처리 할 것인가?
      1. 결국 못 함 type은 따로 tsc를 사용해서 컴파일함 (svgr이 사용하긴 편한대 정말 이게 답인가 라는 근원적인 물음이 있음)
      2. 추후에 패키지로 빼던지 해야함
      3. 에러 메시지를 보면 default export를 못 한다고함 ...?
   2. css로 만드는 스타일 시트를 어떻게 생성 할 것인가?
      1. panda 예제를 보고 따라했지만 내가 생각하던 것 처럼 당연히 안 됨
         1. 시도한 것
            1. buildInfo를 사용해서 빌드 정보를 남기기 -> 동작 자체를 안 함 -> 왜? -> 모르겠음 ㅠㅠ
            2. 빌드 할 떄 css 스타일 시트를 만들어서 배포에 포함하기 -> config에 넣은게 아니라 필요한 class를 전부 생성하지를 못 함
            3. styled-system을 포함 하거나 사용하는 앱에서 사용하게 하기
               1. package.json에 import 를 사용하여 재맵핑 (정답 심지어 예제에 있었음 근대 내가 맘에 안 듦)
   3. 의존으로 가지고 있는 라이브러리의 빌드는 어떻게 처리 할 것인가? -> 빌드 할 떄 예외 처리해둠
   4. panda는 prepare로 panda codegen을 수행 하고 있는대 이부분을 빌드 전에 넣어주어야함
   5. @styles라고 styled-system 을 딱 하나 절대경로로 맵핑 했는대 이게 터지기 시작
   6. 빌드 도구에대한 공부 필요 -> 최신 도구인 tsup으로 했지만 지금 생각은 esbuild이어도 충분 할 듯
      1. tsup의 onSuccess 를 사용해서 빌드 후에 tsc를 적용하려고 했지만 라이프 사이클이 달라서 결국 손으로 직접 컴파일 하게함
   7. js의 모듈 시스템에대해서 공부 (cjs, mjs, mts, cts, \*.d.ts, sourcemap)
   8. 현재 모노레포에서도 브레이킹 체인인지가 많이 없어야함
      1. 현재 구축해둔 빌드 시스템이 깨질 수 있음 -> 실제로 깨짐 (지금도 고생중)
      2. 덕분에 모노레포의 빌드 시스템과 오케스트레이션에 대해서 공부함
      3. 라이브러리 배포 경험이 없어 package.json의 스펙을 많이 알게됨 name, publicConfig, exports, files, peer, etc...
      4. 빌드 하다 보니 다른 내부 패키지에 의존 하고 있어 패키지 전체를 빌드하게 됨 -> 다음부터는 이 부분도 고려해볼 것

3. 배포 시스템 구축

   1. changeset에 대한 지식이 전부 공부 필요
   2. github npm에 배포 (이것도 지식이 전무)
      1. 배포 하기위한 토큰이 필요 -> 찾아보니 name이 달라서(scope 문제) 배포 불가능 그대로 가져갈거면 github 조직을 새로 만들어야함 -> 결국
         모노레포 서비스의 임포트를 전부 교체
      2. 토큰 권한이 부족함 -> 내 개인 토큰으로는 안 되어서 깃허브 토큰을 받아서 넣음 (레거시가 되어버림)
   3. 시멘틱 버저닝 (직접 고려해본건 처음)
   4. 개발자가 손을 대지 않고 자동으로 버전 관리되도록 구축
      1. 커밋 메시지를 분석하여 버저닝을 하도록 설계
   5. 브랜치에 이제 필수 actions 설정
      1. 기존 워크플로우도 잘 동작하도록 고려(하지만 깨졌죠?)
      2. 무한 재귀까지 돌기 시작 (미치겠음)

4. 다른 서비스에서의 적용

   1. remix + 테일윈드를 사용하는 서비스
      1. mantine + panda css 의 조합이 저 위에 잘 올라갈 것인가?
      2. mantine 공식 홈페이지에서는 이제 remix를 지원 하지 않는다고 이야기 함 -> remix 자체가 없어져서 그런거 같음
      3. mantine + tailwind 조합은 적용 시키기 매우 어렵다고 이슈도 많이 올라옴
      4. 기존 테일윈드 베이스에 panda css 스타일을 어떻게 하면 적용하는지도 관건
      5. 심지어 전역 css에 온갖 하드 코딩으로 css가 박혀있음
   2. 적용 시작
      1. 우여곡절끝에 일단 설치는 완료
         1. 배포 하지 않고 로컬에서만 돌아가도록 임시페이지 설정
      2. 하지만 역시 css 적용이 안 됨
         1. postcss까지 직접 만들어보았지만 실패
      3. 뭔지 몰라서 소스 코드 통채로 넣어서 내보내니 일단 성공
         1. 성공 이유 styled-system조차 통채로 들어있어서 panda css의 함수를 찾아감
      4. 기존 css와 합치니 박살남
         1. css layer 설정을 통해 우선순위 지정 (해결 유일하게 원하던대로 한거)

5. 라이브러리 업데이트 시 전파 방법 고민

   1. 육성으로 한다.
   2. 슬랙 채널로 알린다.

6. 우여곡절 끝에 일단 사용이 가능한 형태로 시스템 구축 완성
   1. 해야할 것
      1. 빌드 사이즈 줄이기 현재 20mb -> 목표 300kb 언더 (정적 리소스 빼고 나면 이정도가 나옴)
      2. 트리쉐이킹한 가능한 구조를 만들도록 디자인 시스템 패키지 구조 변경
      3. typescript 완벽하게 적용 시키기
      4. svg 패키지로 빼서 관리하기 type을 위해
      5. buildInfo나 완전 정적인 스타일 시트 만들어서 내보내기
      6. 문서화를 좀 더 꼼꼼히 하여 사람에게 의존하지 않도록 해야함
      7. 로티 파일을 사용한 컴포넌트가 동작을 안 함 (이유 분석 필요)
