# 모노레포에 있는 디자인 시스템 배포 해서 다른 서비스에 적용하기

## 걱정하면서 단계적으로 어떻게 할건지 고민 고민

1. 상황 설명

   1. 왜 모노레포로 하게 되었나?
      1. 신규 프로젝트와 디자인 시스템을 같이 구현하자고 논의가 나왔음
      2. 그래서 이건 언젠간 내보낼 아이야 하면서 모노레포로 구성함
      3. 게다가 추가 프로젝트도 들어오기로 한 상황이라 모노레포로 구성함
   2. 디자인 시스템은 무엇으로 구성 했나?
      1. mantine + panda-css 구성으로 했다.
      2. 리소스 부족과 tailwind의 문법이 극혐이어서 다들 동의해서 썻다.
      3. name을 당당하게 하고 싶은대로 설정 했다(이러지 말았어야 함 scope에 걸림)
   3. 현재 모노레포 구조
      1. 디자인 시스템 패키지 1개 (메인)
      2. 디자인 시스템이 의존하는 내부 패키지 4개 -> 이게 왜 들어감? gnb 때문에... 여기에 몽땅 때려넣고 있음
         1. @package/core (HTTP 클라이언트, 상태 코드 등)
         2. @package/constants
         3. @package/entities
         4. @package/service
      3. 디펜더시 구성
         1. peerDependency로 저걸 넣었다
            1. 왜냐? 중복 설치하게 하지않게 하기 (pnpm 특성 반영)
            2. 그냥 종합 패키지로 넣어줄 수도 있을텐데? -> 다른 패키지들은 공통 로직이 많아 재활용될 수 있도록 구성 했다.
   4. 요구사항
      1. 바로 뒤에 앉은 사람이지만 다른 팀 사람
      2. 디자인 시스템을 NPM 패키지로 배포
      3. 모노레포 외부의 다른 서비스에서 설치 가능하게 만들기
         1. remix + tailwind 환경에서 디자인 시스템 (mantine + panda-css) 잘 돌아가게 하기
   5. 왜 미리 잘 구성을 했음에도 바로 사용하지 못 하였는가?
      1. 모노레포 안에 있는 패키지라 밖으로 내보내야지만 가능
      2. 내부 패키지 4개를 어떻게 처리할 것인가?
      3. remix + tailwind 환경에서도 적용 가능 해야함

2. TODOLIST 작성

3. 빌드

   1. 도구 선정하기 (tsup) 그 때 당시 빠른 빌드와 type을 동시에 지원해주는 도구를 찾고 있었음
   2. 레퍼런스 찾기 -> pandacss를 어떻게 라이브러리 화 시키냐에 초점을 맞춤
      1. panda css에 공홈에 여러가지 케이스 및 보일러플레이트가 있지만 나에겐 맞지 않음 및 내가 못 찾음
   3. svg를 svgr로 사용하고 있는대 어떻게 처리 할 것인가? => 직접 빌드를 돌려보니 tsup이 default 구문을 처리 못 함
      1. 결국 못 함 type은 따로 tsc를 사용해서 컴파일함 (svgr이 사용하긴 편한대 정말 이게 답인가 라는 근원적인 물음이 있음)
      2. 추후에 패키지로 빼던지 해야함
      3. 에러 메시지를 보면 default export를 못 한다고함 ...?
   4. css로 만드는 스타일 시트를 어떻게 생성 할 것인가?
      1. panda 예제를 보고 따라했지만 내가 생각하던 것 처럼 당연히 안 됨
         1. 시도한 것
            1. buildInfo를 사용해서 빌드 정보를 남기기 -> 동작 자체를 안 함 -> 왜? -> 클라이언트 측에 info 설정을 안 해둔게 문제였음
            2. 빌드 할 떄 css 스타일 시트를 만들어서 배포에 포함하기 -> config에 넣은게 아니라 필요한 class를 전부 생성하지를 못 함
   5. 의존으로 가지고 있는 라이브러리의 빌드는 어떻게 처리 할 것인가? -> 빌드 할 떄 예외 처리해둠
   6. panda는 prepare로 panda codegen을 수행 하고 있는대 이부분을 빌드 전에 넣어주어야함
   7. @styles라고 styled-system 을 딱 하나 절대경로로 맵핑 했는대 이게 터지기 시작
   8. 빌드 도구에대한 공부 필요 -> 최신 도구인 tsup으로 했지만 지금 생각은 esbuild이어도 충분 할 듯
      1. tsup의 onSuccess 를 사용해서 빌드 후에 tsc를 적용하려고 했지만 라이프 사이클이 달라서 결국 손으로 직접 컴파일 하게함
   9. js의 모듈 시스템에대해서 공부 (cjs, mjs, mts, cts, \*.d.ts, sourcemap)
   10. 현재 모노레포에서도 브레이킹 체인인지가 많이 없어야함
       1. 현재 구축해둔 빌드 시스템이 깨질 수 있음 -> 실제로 깨짐 (지금도 고생중)
       2. 덕분에 모노레포의 빌드 시스템과 오케스트레이션에 대해서 공부함
       3. 라이브러리 배포 경험이 없어 package.json의 스펙을 많이 알게됨 name, publicConfig, exports, files, peer, etc...
       4. 빌드 하다 보니 다른 내부 패키지에 의존 하고 있어 패키지 전체를 빌드하게 됨 -> 다음부터는 이 부분도 고려해볼 것

4. 적용 확인

   1. 어떻게 하면 빠른 디버깅을 할 수 있을 것인가?
      1. pack으로 묶어서 바로 바로 설치하면서 확인 -> 별다른 고민 없이 복붙만 하면 됨
      2. localhost로 가상 라이브러리 서버를 설치해서 사용 -> pack이 성공 했을 시 실제 환경과 조금 더 비슷하게 맞추기 위해서 사용
      3. git actions로 노가다 하면서 배포 시스템 구축하기
   2. 일단 예상하기 어려운건 지우고 시작 하자
      1. 일단 기존 css는 다지우자 지금 하는 것만으로도 벅차다
      2. 방해 되는건 일단 다 지워버린다.

5. 배포 시스템 구축

   1. changeset에 대한 지식 전부 공부 필요
   2. github npm에 배포 (이것도 지식이 전무)
      1. 배포 하기위한 토큰이 필요 -> 찾아보니 name이 달라서(scope 문제) 배포 불가능 그대로 가져갈거면 github 조직을 새로 만들어야함 -> 결국
         모노레포 서비스의 임포트를 전부 교체
      2. 토큰 권한이 부족함 -> 내 개인 토큰으로는 안 되어서 깃허브 토큰을 받아서 넣음 (레거시가 되어버림)
   3. 시멘틱 버저닝 (직접 고려해본건 처음)
   4. 개발자가 손을 대지 않고 자동으로 버전 관리되도록 구축
      1. 커밋 메시지를 분석하여 버저닝을 하도록 설계
   5. 브랜치에 이제 필수 actions 설정
      1. 기존 워크플로우도 잘 동작하도록 고려(하지만 깨졌죠?)
      2. 무한 재귀까지 돌기 시작 (미치겠음)

6. 다른 서비스에서의 적용

   1. remix + 테일윈드를 사용하는 서비스
      1. mantine + panda css 의 조합이 저 위에 잘 올라갈 것인가?
      2. mantine 공식 홈페이지에서는 이제 remix를 지원 하지 않는다고 이야기 함 -> remix 자체가 없어져서 그런거 같음
      3. mantine + tailwind 조합은 적용 시키기 매우 어렵다고 이슈도 많이 올라옴
      4. 기존 테일윈드 베이스에 panda css 스타일을 어떻게 하면 적용하는지도 관건
      5. 심지어 전역 css에 온갖 하드 코딩으로 css가 박혀있음
   2. 적용 시작
      1. 우여곡절끝에 일단 설치는 완료
         1. 배포 하지 않고 로컬에서만 돌아가도록 임시페이지 설정
      2. 하지만 역시 css 적용이 안 됨
         1. postcss까지 직접 만들어보았지만 실패
      3. 뭔지 몰라서 소스 코드 통채로 넣어서 내보내니 일단 성공
         1. 성공 이유 styled-system조차 통채로 들어있어서 panda css의 함수를 찾아감
      4. 기존 css와 합치니 박살남
         1. css layer 설정을 통해 우선순위 지정 (해결 유일하게 원하던대로 한거)

7. 라이브러리 업데이트 시 전파 방법 고민

   1. 육성으로 한다.
   2. 슬랙 채널로 알린다.

8. 우여곡절 끝에 일단 사용이 가능한 형태로 시스템 구축 완성
   1. 해야할 것
      1. 빌드 사이즈 줄이기 현재 20mb -> 목표 300kb 언더 (정적 리소스 빼고 나면 이정도가 나옴)
      2. 트리쉐이킹한 가능한 구조를 만들도록 디자인 시스템 패키지 구조 변경
      3. typescript 완벽하게 적용 시키기
      4. svg 패키지로 빼서 관리하기 type을 위해
      5. buildInfo나 완전 정적인 스타일 시트 만들어서 내보내기
      6. 문서화를 좀 더 꼼꼼히 하여 사람에게 의존하지 않도록 해야함
      7. 로티 파일을 사용한 컴포넌트가 동작을 안 함 (이유 분석 필요)

---

**"모노레포 디자인 시스템 NPM 배포하기: 3주간의 우여곡절"**

1. **프롤로그**: "어떻게든 되겠지의 나의 기대는 고통의 시작이었다." - 3주의 삽질기 시작
2. **1부 빌드**: SVG, CSS, 모듈시스템과 씨름하며 20MB 괴물 탄생
3. **2부 배포**: Changeset, GitHub Actions, npm scope의 지옥 체험
4. **3부 적용**: Remix + Tailwind + Mantine + Panda CSS 조합의 현실
5. **epilogue**: 20MB → 300KB 최적화 로드맵과 교훈

### 왜 이 주제를 선택하게 되었는지 배경이 궁금합니다.

**현실적인 이유:**

- 팀에서 "디자인 시스템 다른 프로젝트에서도 쓸 수 있게 해주세요"라는 요청이 들어왔음
- "별거 아니겠지"라고 생각했다가 3주 동안 삽질한 경험
- 블로그 글로는 다루기 어려운 생생한 삽질 과정을 공유하고 싶었음

**개인적인 동기:**

- 모노레포 구조에서 라이브러리 배포 경험이 전무했음
- npm 패키지 배포, 모듈 시스템, 빌드 도구에 대한 깊은 이해 필요성 느꼈음
- 실패와 성공을 반복하며 얻은 인사이트를 다른 개발자들과 나누고 싶었음

### 이 발표의 핵심 메시지는 무엇인가요?

**"별거 아닌 일은 없다. 하지만 포기하지 않으면 결국 해낼 수 있다."**

**세부 메시지들:**

1. **"준비의 중요성"**: 무작정 시작하지 말고 로컬 테스트 환경부터 구축하자
2. **"현실적 타협"**: 완벽한 해결책보다는 팀 상황에 맞는 실용적 선택을 하자
3. **"지속적 개선"**: 일단 돌아가게 만든 후 점진적으로 최적화하자
4. **"경험의 가치"**: 삽질도 결국 소중한 학습 과정이다

### 핵심 메시지의 근거가 되는 세부내용을 알려주세요.

**1. 준비의 중요성**

- `pnpm pack` 을 통한 로컬 테스트 환경 구축 → 빠른 피드백 루프 형성
- 기존 CSS 제거 결정 → 복잡도 줄여 핵심에 집중할 수 있었음

**2. 현실적 타협의 사례들**

- SVGR 처리 포기 → TypeScript 컴파일과 분리해서 해결
- "소스코드 통째로 내보내기" → 비효율적이지만 일단 동작하게 만듦
- npm scope 문제 → 전체 import 교체라는 큰 작업으로 해결
- 업데이트 전파 방법 → "육성으로 한다" (가장 확실한 방법)

**3. 지속적 개선 로드맵**

- 20MB → 300KB 목표 설정
- Tree shaking, 타입 완성도, SVG 패키지 분리 등 단계별 계획

**4. 경험을 통한 학습**

- 모듈 시스템 (CJS/ESM) 깊이 있게 학습
- package.json 스펙 완전 이해 (exports, files, peer dependencies 등)
- 빌드 도구 비교 분석 (tsup vs esbuild)
- CSS Layer 활용한 우선순위 제어

### 이 발표를 통해서 본인이 얻고자 하는 점 혹은 청중들에게 전달하고자 하는 점에 대해서 솔직한 나의 기대를 알려주세요.

**개인적으로 얻고자 하는 것:**

**피드백과 검증:**

- 내가 선택한 기술적 결정들이 정말 합리적이었는지 확인하고 싶음
- 다른 개발자들은 비슷한 상황에서 어떻게 해결했는지 궁금함
- 더 나은 대안이나 놓친 부분이 있다면 알고 싶음

**네트워킹과 성장:**

- 비슷한 경험을 한 개발자들과 연결되고 싶음
- 향후 프로젝트에서 협업할 수 있는 인맥 형성
- 나의 기술적 성장 과정을 인정받고 싶은 마음

**청중들에게 전달하고자 하는 것:**

**실무적 가치:**

- "나도 이런 삽질을 할 뻔했는데 미리 알게 되어 다행이다"
- 모노레포 → NPM 패키지 배포 시 마주할 함정들을 미리 경고
- 실제로 사용할 수 있는 체크리스트와 해결책 제공

**심리적 위안:**

- "개발하다 막히는 건 나만의 문제가 아니구나"
- "완벽하지 않아도 일단 해결하고 개선해나가면 된다"
- "3주 삽질도 결국 의미 있는 과정이었다"

**솔직한 기대:**

- 발표 후 "저도 비슷한 경험 있어요!" 하며 다가와 주는 사람들이 있었으면 좋겠음
- "덕분에 삽질 안 하고 성공했어요" 라는 후기를 언젠가 들어보고 싶음
- 이 경험이 다른 팀, 다른 회사에서도 도움이 되었으면 함
- 무엇보다 "별거 아니라고 하지 마세요!"라는 메시지가 전달되었으면 좋겠음
