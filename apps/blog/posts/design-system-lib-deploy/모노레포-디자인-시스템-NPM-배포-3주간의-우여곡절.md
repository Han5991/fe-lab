---
published: false
title: '모노레포 디자인 시스템 NPM 배포하기: 3주간의 우여곡절'
description: '어떻게든 되겠지라는 안일한 생각으로 시작했다가 3주간의 험난한 여정을 겪으며 모노레포에 있던 디자인 시스템을 NPM 패키지로 배포하고, 다른 서비스에 적용하기까지의 모든 과정을 공유합니다.'
date: null
slug: 'monorepo-design-system-npm-deploy-struggle'
tags: ['monorepo', 'design-system', 'npm', 'panda-css', 'tsup', 'changeset', 'react']
---

## 프롤로그: "별거 아니겠지"의 비극

"디자인 시스템, 다른 프로젝트에서도 쓸 수 있게 NPM으로 배포해주세요."

바로 옆자리에 앉은 다른 팀 동료의 요청이었습니다. 저희는 신규 프로젝트와 디자인 시스템을 동시에 개발하고 있었고, 확장성을 고려해 처음부터 모노레포 구조를 채택했습니다. `mantine`과 `panda-css`로 만든 디자인 시스템 패키지는 이미 존재했죠. 그저 밖으로 꺼내주기만 하면 되는 일이었습니다.

"네, 금방 해드릴게요!"

어떻게든 되겠지, 별거 아니겠지. 나의 이 안일한 기대는 앞으로 펼쳐질 3주간의 고통스러운 삽질의 서막이었습니다.

## 1부: 빌드 - 20MB 괴물의 탄생

첫 번째 관문은 '빌드'였습니다. 라이브러리 배포 경험이 전무했던 저는 `tsup`이라는 도구를 선택했습니다. 빠르고, 별도 설정 없이 TypeScript를 지원한다는 점이 매력적이었습니다. 하지만 현실은 달랐습니다.

### SVG, 너란 녀석은...

디자인 시스템에서 아이콘을 `svgr`로 사용하던 것이 문제의 시작이었습니다. `tsup`이 `svgr`의 `export default` 구문을 제대로 처리하지 못하는 이슈가 발생했습니다. 결국 SVG 컴포넌트의 타입 정의(`*.d.ts`)는 `tsc`로 별도 컴파일하는 반쪽짜리 해결책을 선택해야 했습니다.

### Panda CSS, 너는 왜...

다음은 `panda-css`였습니다. 어떻게 스타일시트를 생성해서 라이브러리에 포함시켜야 할까요? 공식 문서를 따라 `buildInfo`도 써보고, 빌드 시점에 CSS 파일을 생성하는 방법도 시도했지만 모두 실패했습니다. 원인은 간단했습니다. 라이브러리를 사용하는 클라이언트 측에 `panda-css` 설정이 없으면, 어떤 클래스가 필요한지 알 수 없어 CSS를 생성조차 할 수 없었던 것입니다.

### 꼬리에 꼬리를 무는 의존성

설상가상으로 `@styles` 같은 절대경로, 내부 패키지(`@package/core` 등)에 대한 의존성이 발목을 잡았습니다. 결국 디자인 시스템 하나를 빌드하려다 모노레포의 모든 패키지를 빌드하게 되는 상황에 이르렀습니다.

이 과정에서 저는 JavaScript 모듈 시스템(CJS, ESM), `package.json`의 `exports`, `files` 같은 스펙, 그리고 빌드 도구의 라이프사이클에 대해 밑바닥부터 다시 공부해야 했습니다.

**그렇게 탄생한 첫 결과물은 무려 20MB짜리 거대한 괴물이었습니다.**

## 2부: 배포 - 끝나지 않는 지옥

빌드라는 산을 넘자, '배포'라는 더 큰 산이 기다리고 있었습니다.

### Changeset과 GitHub Actions

자동으로 버전을 관리하고 배포하고 싶다는 욕심에 `changeset`을 도입했습니다. 커밋 메시지를 분석해 시맨틱 버저닝을 자동화하고, GitHub Actions로 NPM에 배포하는 워크플로우를 설계했습니다. 하지만 이 또한 순탄치 않았습니다.

### Scope, 토큰, 그리고 무한 루프

가장 큰 문제는 패키지 이름의 `scope`였습니다. `@`로 시작하는 `scope`는 특정 NPM 조직에 속해야만 배포가 가능합니다. 제가 설정한 이름은 개인 계정으로는 배포할 수 없었습니다. 결국 모노레포 내 모든 서비스의 `import` 구문을 새로운 패키지 이름으로 교체하는 대작업을 해야만 했습니다.

여기에 배포용 토큰 권한 문제, 기존 워크플로우와의 충돌로 인한 무한 재귀 실행까지... 배포 시스템을 구축하는 과정은 그야말로 지옥이었습니다.

## 3부: 적용 - CSS와의 전쟁

우여곡절 끝에 배포에 성공하고, 드디어 다른 서비스에 적용하는 마지막 단계에 이르렀습니다. 적용할 서비스는 `Remix`와 `Tailwind CSS`를 사용하고 있었습니다.

### Remix + Tailwind + Mantine + Panda CSS = ?

예상대로 순탄치 않았습니다. `mantine`은 더 이상 `Remix`를 공식 지원하지 않았고, `Tailwind CSS`와 `Panda CSS`의 스타일이 충돌하며 모든 것이 깨져 보였습니다.

결국 원인을 찾지 못해 소스 코드를 통째로 빌드 결과물에 포함시키는 극단적인 방법을 사용했습니다. `styled-system`까지 통째로 들어가니 일단 동작은 했습니다.

그리고 마침내, `CSS Layer` 설정을 통해 `Tailwind`와 `Panda`의 스타일 우선순위를 제어하는 데 성공하며 기나긴 전쟁을 끝낼 수 있었습니다. 유일하게 제가 원했던 대로 동작한 순간이었습니다.

## 에필로그: 300KB를 향한 로드맵

현재 저희 디자인 시스템은 여전히 20MB에 가까운 크기를 자랑하지만, 어쨌든 동작하고 있습니다. 업데이트 소식은 슬랙 채널과 육성으로 알리고 있죠. 완벽하진 않지만, 우리는 해냈습니다.

이번 3주간의 삽질은 저에게 값진 교훈을 남겼습니다.

- **별거 아닌 일은 없다:** 무작정 시작하기 전에, `pnpm pack` 등을 활용한 로컬 테스트로 위험을 최소화하자.
- **현실과 타협하라:** 완벽함보다는 '일단 돌아가게 만드는 것'이 중요하다.
- **삽질은 성장의 밑거름이다:** 이 과정을 통해 빌드, 배포, 모듈 시스템에 대한 깊은 이해를 얻었다.

이제 남은 과제는 명확합니다.

- **빌드 사이즈 300KB 언더로 줄이기**
- **트리쉐이킹 가능한 구조로 변경**
- **SVG 아이콘 패키지 분리**
- **문서화 및 자동화된 전파 시스템 구축**

"별거 아니겠지"라고 생각했던 일이 3주간의 대장정이 되었지만, 그 끝에서 저는 한 뼘 더 성장할 수 있었습니다. 이 글을 읽는 여러분은 저처럼 고통받지 않기를, 하지만 혹시 비슷한 상황에 처하더라도 포기하지 않기를 바랍니다.
